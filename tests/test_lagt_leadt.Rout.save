
R version 4.0.3 (2020-10-10) -- "Bunny-Wunnies Freak Out"
Copyright (C) 2020 The R Foundation for Statistical Computing
Platform: x86_64-w64-mingw32/x64 (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # tests of lagt and leadt (note the "t") respecting time periods (not just shifting of rows)
> # -> there is also a test file (test_lag_lead_factor_levels.R) for plm::lagr which does not
> #    treat the time variable as a numeric value (merely shifts rows)
> #
> # The lagging with respect to the time dimension is the default for lag since
> #  plm version 1.7-0, i.e., lag(..., shift = "time") is a wrapper for plm::lagt
> #
> #
> #  (1) test of lagging of index variable
> #  (2) some dropped factor levels / whole period missing
> #  (3) general tests
> #  (4) tests with non-consecutive time periods
> #  (5) lagt and lag should yield same results on data with consecutive time periods
> #  (6) NA in time index
> 
> 
> library(plm)
> data("Grunfeld", package = "plm")
> 
> Grunfeld$fac <- factor(c(200:2, 1))
> Grunfeld <- pdata.frame(Grunfeld)
> 
> 
> ############## (1) test of lagging of index variable ##########
> ## test of lagging of index variable
> lag(Grunfeld$firm)
 1-1935  1-1936  1-1937  1-1938  1-1939  1-1940  1-1941  1-1942  1-1943  1-1944 
   <NA>       1       1       1       1       1       1       1       1       1 
 1-1945  1-1946  1-1947  1-1948  1-1949  1-1950  1-1951  1-1952  1-1953  1-1954 
      1       1       1       1       1       1       1       1       1       1 
 2-1935  2-1936  2-1937  2-1938  2-1939  2-1940  2-1941  2-1942  2-1943  2-1944 
   <NA>       2       2       2       2       2       2       2       2       2 
 2-1945  2-1946  2-1947  2-1948  2-1949  2-1950  2-1951  2-1952  2-1953  2-1954 
      2       2       2       2       2       2       2       2       2       2 
 3-1935  3-1936  3-1937  3-1938  3-1939  3-1940  3-1941  3-1942  3-1943  3-1944 
   <NA>       3       3       3       3       3       3       3       3       3 
 3-1945  3-1946  3-1947  3-1948  3-1949  3-1950  3-1951  3-1952  3-1953  3-1954 
      3       3       3       3       3       3       3       3       3       3 
 4-1935  4-1936  4-1937  4-1938  4-1939  4-1940  4-1941  4-1942  4-1943  4-1944 
   <NA>       4       4       4       4       4       4       4       4       4 
 4-1945  4-1946  4-1947  4-1948  4-1949  4-1950  4-1951  4-1952  4-1953  4-1954 
      4       4       4       4       4       4       4       4       4       4 
 5-1935  5-1936  5-1937  5-1938  5-1939  5-1940  5-1941  5-1942  5-1943  5-1944 
   <NA>       5       5       5       5       5       5       5       5       5 
 5-1945  5-1946  5-1947  5-1948  5-1949  5-1950  5-1951  5-1952  5-1953  5-1954 
      5       5       5       5       5       5       5       5       5       5 
 6-1935  6-1936  6-1937  6-1938  6-1939  6-1940  6-1941  6-1942  6-1943  6-1944 
   <NA>       6       6       6       6       6       6       6       6       6 
 6-1945  6-1946  6-1947  6-1948  6-1949  6-1950  6-1951  6-1952  6-1953  6-1954 
      6       6       6       6       6       6       6       6       6       6 
 7-1935  7-1936  7-1937  7-1938  7-1939  7-1940  7-1941  7-1942  7-1943  7-1944 
   <NA>       7       7       7       7       7       7       7       7       7 
 7-1945  7-1946  7-1947  7-1948  7-1949  7-1950  7-1951  7-1952  7-1953  7-1954 
      7       7       7       7       7       7       7       7       7       7 
 8-1935  8-1936  8-1937  8-1938  8-1939  8-1940  8-1941  8-1942  8-1943  8-1944 
   <NA>       8       8       8       8       8       8       8       8       8 
 8-1945  8-1946  8-1947  8-1948  8-1949  8-1950  8-1951  8-1952  8-1953  8-1954 
      8       8       8       8       8       8       8       8       8       8 
 9-1935  9-1936  9-1937  9-1938  9-1939  9-1940  9-1941  9-1942  9-1943  9-1944 
   <NA>       9       9       9       9       9       9       9       9       9 
 9-1945  9-1946  9-1947  9-1948  9-1949  9-1950  9-1951  9-1952  9-1953  9-1954 
      9       9       9       9       9       9       9       9       9       9 
10-1935 10-1936 10-1937 10-1938 10-1939 10-1940 10-1941 10-1942 10-1943 10-1944 
   <NA>      10      10      10      10      10      10      10      10      10 
10-1945 10-1946 10-1947 10-1948 10-1949 10-1950 10-1951 10-1952 10-1953 10-1954 
     10      10      10      10      10      10      10      10      10      10 
Levels: 1 2 3 4 5 6 7 8 9 10
> 
> # variable identical to an index "on character level"
> Grunfeld$firm2 <- Grunfeld$firm
> lag(Grunfeld$firm2)
 1-1935  1-1936  1-1937  1-1938  1-1939  1-1940  1-1941  1-1942  1-1943  1-1944 
   <NA>       1       1       1       1       1       1       1       1       1 
 1-1945  1-1946  1-1947  1-1948  1-1949  1-1950  1-1951  1-1952  1-1953  1-1954 
      1       1       1       1       1       1       1       1       1       1 
 2-1935  2-1936  2-1937  2-1938  2-1939  2-1940  2-1941  2-1942  2-1943  2-1944 
   <NA>       2       2       2       2       2       2       2       2       2 
 2-1945  2-1946  2-1947  2-1948  2-1949  2-1950  2-1951  2-1952  2-1953  2-1954 
      2       2       2       2       2       2       2       2       2       2 
 3-1935  3-1936  3-1937  3-1938  3-1939  3-1940  3-1941  3-1942  3-1943  3-1944 
   <NA>       3       3       3       3       3       3       3       3       3 
 3-1945  3-1946  3-1947  3-1948  3-1949  3-1950  3-1951  3-1952  3-1953  3-1954 
      3       3       3       3       3       3       3       3       3       3 
 4-1935  4-1936  4-1937  4-1938  4-1939  4-1940  4-1941  4-1942  4-1943  4-1944 
   <NA>       4       4       4       4       4       4       4       4       4 
 4-1945  4-1946  4-1947  4-1948  4-1949  4-1950  4-1951  4-1952  4-1953  4-1954 
      4       4       4       4       4       4       4       4       4       4 
 5-1935  5-1936  5-1937  5-1938  5-1939  5-1940  5-1941  5-1942  5-1943  5-1944 
   <NA>       5       5       5       5       5       5       5       5       5 
 5-1945  5-1946  5-1947  5-1948  5-1949  5-1950  5-1951  5-1952  5-1953  5-1954 
      5       5       5       5       5       5       5       5       5       5 
 6-1935  6-1936  6-1937  6-1938  6-1939  6-1940  6-1941  6-1942  6-1943  6-1944 
   <NA>       6       6       6       6       6       6       6       6       6 
 6-1945  6-1946  6-1947  6-1948  6-1949  6-1950  6-1951  6-1952  6-1953  6-1954 
      6       6       6       6       6       6       6       6       6       6 
 7-1935  7-1936  7-1937  7-1938  7-1939  7-1940  7-1941  7-1942  7-1943  7-1944 
   <NA>       7       7       7       7       7       7       7       7       7 
 7-1945  7-1946  7-1947  7-1948  7-1949  7-1950  7-1951  7-1952  7-1953  7-1954 
      7       7       7       7       7       7       7       7       7       7 
 8-1935  8-1936  8-1937  8-1938  8-1939  8-1940  8-1941  8-1942  8-1943  8-1944 
   <NA>       8       8       8       8       8       8       8       8       8 
 8-1945  8-1946  8-1947  8-1948  8-1949  8-1950  8-1951  8-1952  8-1953  8-1954 
      8       8       8       8       8       8       8       8       8       8 
 9-1935  9-1936  9-1937  9-1938  9-1939  9-1940  9-1941  9-1942  9-1943  9-1944 
   <NA>       9       9       9       9       9       9       9       9       9 
 9-1945  9-1946  9-1947  9-1948  9-1949  9-1950  9-1951  9-1952  9-1953  9-1954 
      9       9       9       9       9       9       9       9       9       9 
10-1935 10-1936 10-1937 10-1938 10-1939 10-1940 10-1941 10-1942 10-1943 10-1944 
   <NA>      10      10      10      10      10      10      10      10      10 
10-1945 10-1946 10-1947 10-1948 10-1949 10-1950 10-1951 10-1952 10-1953 10-1954 
     10      10      10      10      10      10      10      10      10      10 
Levels: 1 2 3 4 5 6 7 8 9 10
> 
> 
> ############## (2.1) tests with eliminated factor levels ##########
> 
> # lag by 1 eliminates some factor levels (e.g., "1" in the last observations)
> # from the sample's unique factor levels, but it should stay in the levels
> lag(Grunfeld$fac)
 1-1935  1-1936  1-1937  1-1938  1-1939  1-1940  1-1941  1-1942  1-1943  1-1944 
   <NA>     200     199     198     197     196     195     194     193     192 
 1-1945  1-1946  1-1947  1-1948  1-1949  1-1950  1-1951  1-1952  1-1953  1-1954 
    191     190     189     188     187     186     185     184     183     182 
 2-1935  2-1936  2-1937  2-1938  2-1939  2-1940  2-1941  2-1942  2-1943  2-1944 
   <NA>     180     179     178     177     176     175     174     173     172 
 2-1945  2-1946  2-1947  2-1948  2-1949  2-1950  2-1951  2-1952  2-1953  2-1954 
    171     170     169     168     167     166     165     164     163     162 
 3-1935  3-1936  3-1937  3-1938  3-1939  3-1940  3-1941  3-1942  3-1943  3-1944 
   <NA>     160     159     158     157     156     155     154     153     152 
 3-1945  3-1946  3-1947  3-1948  3-1949  3-1950  3-1951  3-1952  3-1953  3-1954 
    151     150     149     148     147     146     145     144     143     142 
 4-1935  4-1936  4-1937  4-1938  4-1939  4-1940  4-1941  4-1942  4-1943  4-1944 
   <NA>     140     139     138     137     136     135     134     133     132 
 4-1945  4-1946  4-1947  4-1948  4-1949  4-1950  4-1951  4-1952  4-1953  4-1954 
    131     130     129     128     127     126     125     124     123     122 
 5-1935  5-1936  5-1937  5-1938  5-1939  5-1940  5-1941  5-1942  5-1943  5-1944 
   <NA>     120     119     118     117     116     115     114     113     112 
 5-1945  5-1946  5-1947  5-1948  5-1949  5-1950  5-1951  5-1952  5-1953  5-1954 
    111     110     109     108     107     106     105     104     103     102 
 6-1935  6-1936  6-1937  6-1938  6-1939  6-1940  6-1941  6-1942  6-1943  6-1944 
   <NA>     100      99      98      97      96      95      94      93      92 
 6-1945  6-1946  6-1947  6-1948  6-1949  6-1950  6-1951  6-1952  6-1953  6-1954 
     91      90      89      88      87      86      85      84      83      82 
 7-1935  7-1936  7-1937  7-1938  7-1939  7-1940  7-1941  7-1942  7-1943  7-1944 
   <NA>      80      79      78      77      76      75      74      73      72 
 7-1945  7-1946  7-1947  7-1948  7-1949  7-1950  7-1951  7-1952  7-1953  7-1954 
     71      70      69      68      67      66      65      64      63      62 
 8-1935  8-1936  8-1937  8-1938  8-1939  8-1940  8-1941  8-1942  8-1943  8-1944 
   <NA>      60      59      58      57      56      55      54      53      52 
 8-1945  8-1946  8-1947  8-1948  8-1949  8-1950  8-1951  8-1952  8-1953  8-1954 
     51      50      49      48      47      46      45      44      43      42 
 9-1935  9-1936  9-1937  9-1938  9-1939  9-1940  9-1941  9-1942  9-1943  9-1944 
   <NA>      40      39      38      37      36      35      34      33      32 
 9-1945  9-1946  9-1947  9-1948  9-1949  9-1950  9-1951  9-1952  9-1953  9-1954 
     31      30      29      28      27      26      25      24      23      22 
10-1935 10-1936 10-1937 10-1938 10-1939 10-1940 10-1941 10-1942 10-1943 10-1944 
   <NA>      20      19      18      17      16      15      14      13      12 
10-1945 10-1946 10-1947 10-1948 10-1949 10-1950 10-1951 10-1952 10-1953 10-1954 
     11      10       9       8       7       6       5       4       3       2 
200 Levels: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 ... 200
> if (!(length(unique(Grunfeld$fac)) == 200)) stop("wrong factor levels") # 200
> if (!(length(unique(lag(Grunfeld$fac))) == 191)) stop("wrong actually uniquely occuring factor levels")  # 191
> if (!(length(levels(lag(Grunfeld$fac))) == 200)) stop("wrong factor levels")  # 200
> 
> # lead eliminates e.g., level "200"
> lead(Grunfeld$fac)
 1-1935  1-1936  1-1937  1-1938  1-1939  1-1940  1-1941  1-1942  1-1943  1-1944 
    199     198     197     196     195     194     193     192     191     190 
 1-1945  1-1946  1-1947  1-1948  1-1949  1-1950  1-1951  1-1952  1-1953  1-1954 
    189     188     187     186     185     184     183     182     181    <NA> 
 2-1935  2-1936  2-1937  2-1938  2-1939  2-1940  2-1941  2-1942  2-1943  2-1944 
    179     178     177     176     175     174     173     172     171     170 
 2-1945  2-1946  2-1947  2-1948  2-1949  2-1950  2-1951  2-1952  2-1953  2-1954 
    169     168     167     166     165     164     163     162     161    <NA> 
 3-1935  3-1936  3-1937  3-1938  3-1939  3-1940  3-1941  3-1942  3-1943  3-1944 
    159     158     157     156     155     154     153     152     151     150 
 3-1945  3-1946  3-1947  3-1948  3-1949  3-1950  3-1951  3-1952  3-1953  3-1954 
    149     148     147     146     145     144     143     142     141    <NA> 
 4-1935  4-1936  4-1937  4-1938  4-1939  4-1940  4-1941  4-1942  4-1943  4-1944 
    139     138     137     136     135     134     133     132     131     130 
 4-1945  4-1946  4-1947  4-1948  4-1949  4-1950  4-1951  4-1952  4-1953  4-1954 
    129     128     127     126     125     124     123     122     121    <NA> 
 5-1935  5-1936  5-1937  5-1938  5-1939  5-1940  5-1941  5-1942  5-1943  5-1944 
    119     118     117     116     115     114     113     112     111     110 
 5-1945  5-1946  5-1947  5-1948  5-1949  5-1950  5-1951  5-1952  5-1953  5-1954 
    109     108     107     106     105     104     103     102     101    <NA> 
 6-1935  6-1936  6-1937  6-1938  6-1939  6-1940  6-1941  6-1942  6-1943  6-1944 
     99      98      97      96      95      94      93      92      91      90 
 6-1945  6-1946  6-1947  6-1948  6-1949  6-1950  6-1951  6-1952  6-1953  6-1954 
     89      88      87      86      85      84      83      82      81    <NA> 
 7-1935  7-1936  7-1937  7-1938  7-1939  7-1940  7-1941  7-1942  7-1943  7-1944 
     79      78      77      76      75      74      73      72      71      70 
 7-1945  7-1946  7-1947  7-1948  7-1949  7-1950  7-1951  7-1952  7-1953  7-1954 
     69      68      67      66      65      64      63      62      61    <NA> 
 8-1935  8-1936  8-1937  8-1938  8-1939  8-1940  8-1941  8-1942  8-1943  8-1944 
     59      58      57      56      55      54      53      52      51      50 
 8-1945  8-1946  8-1947  8-1948  8-1949  8-1950  8-1951  8-1952  8-1953  8-1954 
     49      48      47      46      45      44      43      42      41    <NA> 
 9-1935  9-1936  9-1937  9-1938  9-1939  9-1940  9-1941  9-1942  9-1943  9-1944 
     39      38      37      36      35      34      33      32      31      30 
 9-1945  9-1946  9-1947  9-1948  9-1949  9-1950  9-1951  9-1952  9-1953  9-1954 
     29      28      27      26      25      24      23      22      21    <NA> 
10-1935 10-1936 10-1937 10-1938 10-1939 10-1940 10-1941 10-1942 10-1943 10-1944 
     19      18      17      16      15      14      13      12      11      10 
10-1945 10-1946 10-1947 10-1948 10-1949 10-1950 10-1951 10-1952 10-1953 10-1954 
      9       8       7       6       5       4       3       2       1    <NA> 
200 Levels: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 ... 200
> if (!(length(unique(Grunfeld$fac)) == 200)) stop("wrong factor levels") # 200
> if (!(length(unique(lead(Grunfeld$fac))) == 191)) stop("wrong factor levels") # 191
> if (!(length(levels(lead(Grunfeld$fac))) == 200)) stop("wrong factor levels")  # 200
> 
> 
> ############### (2.2) test for case with a time period missing from whole data set
> data("Grunfeld", package = "plm")
> obs_3rd <- 3 + 20*c(0:9)
> Grunfeld_wo_1937 <- pdata.frame(Grunfeld[-obs_3rd, ])
> 
> # illustration:
> levels(Grunfeld_wo_1937$year) # no year 1937 anymore and no level for 1937 anymore
 [1] "1935" "1936" "1938" "1939" "1940" "1941" "1942" "1943" "1944" "1945"
[11] "1946" "1947" "1948" "1949" "1950" "1951" "1952" "1953" "1954"
> as.numeric(Grunfeld_wo_1937$year)                # as.numeric produces a consecutive series!
  [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19  1  2  3  4  5  6
 [26]  7  8  9 10 11 12 13 14 15 16 17 18 19  1  2  3  4  5  6  7  8  9 10 11 12
 [51] 13 14 15 16 17 18 19  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18
 [76] 19  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19  1  2  3  4  5
[101]  6  7  8  9 10 11 12 13 14 15 16 17 18 19  1  2  3  4  5  6  7  8  9 10 11
[126] 12 13 14 15 16 17 18 19  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17
[151] 18 19  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19  1  2  3  4
[176]  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19
> any(diff(as.numeric(Grunfeld_wo_1937$year)) > 1) # -> no gap detected
[1] FALSE
> 
> as.numeric(as.character(Grunfeld_wo_1937$year)) # use as.character before as.numeric!
  [1] 1935 1936 1938 1939 1940 1941 1942 1943 1944 1945 1946 1947 1948 1949 1950
 [16] 1951 1952 1953 1954 1935 1936 1938 1939 1940 1941 1942 1943 1944 1945 1946
 [31] 1947 1948 1949 1950 1951 1952 1953 1954 1935 1936 1938 1939 1940 1941 1942
 [46] 1943 1944 1945 1946 1947 1948 1949 1950 1951 1952 1953 1954 1935 1936 1938
 [61] 1939 1940 1941 1942 1943 1944 1945 1946 1947 1948 1949 1950 1951 1952 1953
 [76] 1954 1935 1936 1938 1939 1940 1941 1942 1943 1944 1945 1946 1947 1948 1949
 [91] 1950 1951 1952 1953 1954 1935 1936 1938 1939 1940 1941 1942 1943 1944 1945
[106] 1946 1947 1948 1949 1950 1951 1952 1953 1954 1935 1936 1938 1939 1940 1941
[121] 1942 1943 1944 1945 1946 1947 1948 1949 1950 1951 1952 1953 1954 1935 1936
[136] 1938 1939 1940 1941 1942 1943 1944 1945 1946 1947 1948 1949 1950 1951 1952
[151] 1953 1954 1935 1936 1938 1939 1940 1941 1942 1943 1944 1945 1946 1947 1948
[166] 1949 1950 1951 1952 1953 1954 1935 1936 1938 1939 1940 1941 1942 1943 1944
[181] 1945 1946 1947 1948 1949 1950 1951 1952 1953 1954
> any(diff(as.numeric(as.character(Grunfeld_wo_1937$year))) > 1) # -> gap now detected
[1] TRUE
> 
> # formal test:
> if (!is.na(lag( Grunfeld_wo_1937$inv)["1-1938"])) stop("missing time period not detected (year 1937 is missing from whole data set)")
> if (!is.na(lead(Grunfeld_wo_1937$inv)["1-1936"])) stop("missing time period not detected (year 1937 is missing from whole data set)")
> 
> 
> 
> ############## (3) some general tests ##########
> data("Grunfeld", package = "plm")
> 
> Grunfeld$fac <- factor(c(200:2, 1))
> Grunfeld <- pdata.frame(Grunfeld)
> ## some more general testing of lag and lead
> # do nothing
> if (!isTRUE(all.equal(lag(Grunfeld$fac, 0), Grunfeld$fac))) stop("'lag( , 0)' not equal to 'do nothing'")
> if (!isTRUE(all.equal(lead(Grunfeld$fac, 0), Grunfeld$fac))) stop("'lead( , 0)' not equal to 'do nothing'")
>   # identical is even stricter than all.equal
>   if (!identical(lag(Grunfeld$fac, 0), Grunfeld$fac)) stop("'lag( , 0)' not identical to 'do nothing'")
>   if (!identical(lead(Grunfeld$fac, 0), Grunfeld$fac)) stop("'lead( , 0)' not identical to 'do nothing'")
> 
> 
> # lag( , -k) == lead( , k)
> if (!isTRUE(all.equal(lag(Grunfeld$fac, -1), lead(Grunfeld$fac, 1)))) stop("'lag( , -1)' not equal to 'lead( , 1)'")
> if (!isTRUE(all.equal(lag(Grunfeld$fac, 1), lead(Grunfeld$fac, -1)))) stop("'lag( , 1)' not equal to 'lead( , -1)'")
>   # identical is even stricter than all.equal
>   if (!identical(lag(Grunfeld$fac, -1), lead(Grunfeld$fac, 1))) stop("'lag( , -1)' not identical to 'lead( , 1)'")
>   if (!identical(lag(Grunfeld$fac, 1), lead(Grunfeld$fac, -1))) stop("'lag( , 1)' not identical to 'lead( , -1)'")
> 
> # with numeric
> if (!isTRUE(all.equal(lag(Grunfeld$inv, -1), lead(Grunfeld$inv, 1)))) stop("'lag( , -1)' not equal to 'lead( , 1)'")
> if (!isTRUE(all.equal(lag(Grunfeld$inv, 1), lead(Grunfeld$inv, -1)))) stop("'lag( , 1)' not equal to 'lead( , -1)'")
> 
>   if (!identical(lag(Grunfeld$inv, -1), lead(Grunfeld$inv, 1))) stop("'lag( , -1)' not identical to 'lead( , 1)'")
>   if (!identical(lag(Grunfeld$inv, 1), lead(Grunfeld$inv, -1))) stop("'lag( , 1)' not identical to 'lead( , -1)'")
> 
> 
> 
> # with logical
> Grunfeld$log <- rep(c(T, T, F, T), 50)
> if (!isTRUE(all.equal(lag(Grunfeld$log, -1), lead(Grunfeld$log, 1)))) stop("'lag( , -1)' not equal to 'lead( , 1)'")
> if (!isTRUE(all.equal(lag(Grunfeld$log, 1), lead(Grunfeld$log, -1)))) stop("'lag( , 1)' not equal to 'lead( , -1)'")
> 
>   if (!identical(lag(Grunfeld$log, -1), lead(Grunfeld$log, 1))) stop("'lag( , -1)' not identical to 'lead( , 1)'")
>   if (!identical(lag(Grunfeld$log, 1), lead(Grunfeld$log, -1))) stop("'lag( , 1)' not identical to 'lead( , -1)'")
> 
> 
> ## other k's
> if (!isTRUE(all.equal(lag(Grunfeld$inv, -5), lead(Grunfeld$inv, 5)))) stop("'lag( , -1)' not equal to 'lead( , 1)'")
> if (!isTRUE(all.equal(lag(Grunfeld$inv, 5), lead(Grunfeld$inv, -5)))) stop("'lag( , 1)' not equal to 'lead( , -1)'")
> 
> if (!isTRUE(all.equal(lag(Grunfeld$inv, -3), lead(Grunfeld$inv, 3)))) stop("'lag( , -1)' not equal to 'lead( , 1)'")
> if (!isTRUE(all.equal(lag(Grunfeld$inv, 3), lead(Grunfeld$inv, -3)))) stop("'lag( , 1)' not equal to 'lead( , -1)'")
> 
>   if (!identical(lag(Grunfeld$inv, -3), lead(Grunfeld$inv, 3))) stop("'lag( , -1)' not identical to 'lead( , 1)'")
>   if (!identical(lag(Grunfeld$inv, 3), lead(Grunfeld$inv, -3))) stop("'lag( , 1)' not identical to 'lead( , -1)'")
> 
> 
> 
> # should be all NA
> if(!isTRUE(all(is.na(lag(Grunfeld$inv, 20))))) stop("all-NA case not correct") # 20 is no of obs per id
> if(!isTRUE(all(is.na(lag(Grunfeld$inv, 21))))) stop("all-NA case not correct") # 21 is more than obs per id available
> if(!isTRUE(all(is.na(lead(Grunfeld$inv, 20))))) stop("all-NA case not correct") # 20 is no of obs per id
> if(!isTRUE(all(is.na(lead(Grunfeld$inv, 21))))) stop("all-NA case not correct") # 21 is more than obs per id available
> 
> ## length(k) > 1
> lag(Grunfeld$inv, c(-2, -1, 0, 1, 2))
             -2      -1       0       1      2
1-1935   410.60  391.80  317.60      NA     NA
1-1936   257.70  410.60  391.80  317.60     NA
1-1937   330.80  257.70  410.60  391.80 317.60
1-1938   461.20  330.80  257.70  410.60 391.80
1-1939   512.00  461.20  330.80  257.70 410.60
1-1940   448.00  512.00  461.20  330.80 257.70
1-1941   499.60  448.00  512.00  461.20 330.80
1-1942   547.50  499.60  448.00  512.00 461.20
1-1943   561.20  547.50  499.60  448.00 512.00
1-1944   688.10  561.20  547.50  499.60 448.00
1-1945   568.90  688.10  561.20  547.50 499.60
1-1946   529.20  568.90  688.10  561.20 547.50
1-1947   555.10  529.20  568.90  688.10 561.20
1-1948   642.90  555.10  529.20  568.90 688.10
1-1949   755.90  642.90  555.10  529.20 568.90
1-1950   891.20  755.90  642.90  555.10 529.20
1-1951  1304.40  891.20  755.90  642.90 555.10
1-1952  1486.70 1304.40  891.20  755.90 642.90
1-1953       NA 1486.70 1304.40  891.20 755.90
1-1954       NA      NA 1486.70 1304.40 891.20
2-1935   469.90  355.30  209.90      NA     NA
2-1936   262.30  469.90  355.30  209.90     NA
2-1937   230.40  262.30  469.90  355.30 209.90
2-1938   361.60  230.40  262.30  469.90 355.30
2-1939   472.80  361.60  230.40  262.30 469.90
2-1940   445.60  472.80  361.60  230.40 262.30
2-1941   361.60  445.60  472.80  361.60 230.40
2-1942   288.20  361.60  445.60  472.80 361.60
2-1943   258.70  288.20  361.60  445.60 472.80
2-1944   420.30  258.70  288.20  361.60 445.60
2-1945   420.50  420.30  258.70  288.20 361.60
2-1946   494.50  420.50  420.30  258.70 288.20
2-1947   405.10  494.50  420.50  420.30 258.70
2-1948   418.80  405.10  494.50  420.50 420.30
2-1949   588.20  418.80  405.10  494.50 420.50
2-1950   645.50  588.20  418.80  405.10 494.50
2-1951   641.00  645.50  588.20  418.80 405.10
2-1952   459.30  641.00  645.50  588.20 418.80
2-1953       NA  459.30  641.00  645.50 588.20
2-1954       NA      NA  459.30  641.00 645.50
3-1935    77.20   45.00   33.10      NA     NA
3-1936    44.60   77.20   45.00   33.10     NA
3-1937    48.10   44.60   77.20   45.00  33.10
3-1938    74.40   48.10   44.60   77.20  45.00
3-1939   113.00   74.40   48.10   44.60  77.20
3-1940    91.90  113.00   74.40   48.10  44.60
3-1941    61.30   91.90  113.00   74.40  48.10
3-1942    56.80   61.30   91.90  113.00  74.40
3-1943    93.60   56.80   61.30   91.90 113.00
3-1944   159.90   93.60   56.80   61.30  91.90
3-1945   147.20  159.90   93.60   56.80  61.30
3-1946   146.30  147.20  159.90   93.60  56.80
3-1947    98.30  146.30  147.20  159.90  93.60
3-1948    93.50   98.30  146.30  147.20 159.90
3-1949   135.20   93.50   98.30  146.30 147.20
3-1950   157.30  135.20   93.50   98.30 146.30
3-1951   179.50  157.30  135.20   93.50  98.30
3-1952   189.60  179.50  157.30  135.20  93.50
3-1953       NA  189.60  179.50  157.30 135.20
3-1954       NA      NA  189.60  179.50 157.30
4-1935    66.26   72.76   40.29      NA     NA
4-1936    51.60   66.26   72.76   40.29     NA
4-1937    52.41   51.60   66.26   72.76  40.29
4-1938    69.41   52.41   51.60   66.26  72.76
4-1939    68.35   69.41   52.41   51.60  66.26
4-1940    46.80   68.35   69.41   52.41  51.60
4-1941    47.40   46.80   68.35   69.41  52.41
4-1942    59.57   47.40   46.80   68.35  69.41
4-1943    88.78   59.57   47.40   46.80  68.35
4-1944    74.12   88.78   59.57   47.40  46.80
4-1945    62.68   74.12   88.78   59.57  47.40
4-1946    89.36   62.68   74.12   88.78  59.57
4-1947    78.98   89.36   62.68   74.12  88.78
4-1948   100.66   78.98   89.36   62.68  74.12
4-1949   160.62  100.66   78.98   89.36  62.68
4-1950   145.00  160.62  100.66   78.98  89.36
4-1951   174.93  145.00  160.62  100.66  78.98
4-1952   172.49  174.93  145.00  160.62 100.66
4-1953       NA  172.49  174.93  145.00 160.62
4-1954       NA      NA  172.49  174.93 145.00
5-1935    74.24   50.73   39.68      NA     NA
5-1936    53.51   74.24   50.73   39.68     NA
5-1937    42.65   53.51   74.24   50.73  39.68
5-1938    46.48   42.65   53.51   74.24  50.73
5-1939    61.40   46.48   42.65   53.51  74.24
5-1940    39.67   61.40   46.48   42.65  53.51
5-1941    62.24   39.67   61.40   46.48  42.65
5-1942    52.32   62.24   39.67   61.40  46.48
5-1943    63.21   52.32   62.24   39.67  61.40
5-1944    59.37   63.21   52.32   62.24  39.67
5-1945    58.02   59.37   63.21   52.32  62.24
5-1946    70.34   58.02   59.37   63.21  52.32
5-1947    67.42   70.34   58.02   59.37  63.21
5-1948    55.74   67.42   70.34   58.02  59.37
5-1949    80.30   55.74   67.42   70.34  58.02
5-1950    85.40   80.30   55.74   67.42  70.34
5-1951    91.90   85.40   80.30   55.74  67.42
5-1952    81.43   91.90   85.40   80.30  55.74
5-1953       NA   81.43   91.90   85.40  80.30
5-1954       NA      NA   81.43   91.90  85.40
6-1935    25.94   25.98   20.36      NA     NA
6-1936    27.53   25.94   25.98   20.36     NA
6-1937    24.60   27.53   25.94   25.98  20.36
6-1938    28.54   24.60   27.53   25.94  25.98
6-1939    43.41   28.54   24.60   27.53  25.94
6-1940    42.81   43.41   28.54   24.60  27.53
6-1941    27.84   42.81   43.41   28.54  24.60
6-1942    32.60   27.84   42.81   43.41  28.54
6-1943    39.03   32.60   27.84   42.81  43.41
6-1944    50.17   39.03   32.60   27.84  42.81
6-1945    51.85   50.17   39.03   32.60  27.84
6-1946    64.03   51.85   50.17   39.03  32.60
6-1947    68.16   64.03   51.85   50.17  39.03
6-1948    77.34   68.16   64.03   51.85  50.17
6-1949    95.30   77.34   68.16   64.03  51.85
6-1950    99.49   95.30   77.34   68.16  64.03
6-1951   127.52   99.49   95.30   77.34  68.16
6-1952   135.72  127.52   99.49   95.30  77.34
6-1953       NA  135.72  127.52   99.49  95.30
6-1954       NA      NA  135.72  127.52  99.49
7-1935    32.78   23.21   24.43      NA     NA
7-1936    32.54   32.78   23.21   24.43     NA
7-1937    26.65   32.54   32.78   23.21  24.43
7-1938    33.71   26.65   32.54   32.78  23.21
7-1939    43.50   33.71   26.65   32.54  32.78
7-1940    34.46   43.50   33.71   26.65  32.54
7-1941    44.28   34.46   43.50   33.71  26.65
7-1942    70.80   44.28   34.46   43.50  33.71
7-1943    44.12   70.80   44.28   34.46  43.50
7-1944    48.98   44.12   70.80   44.28  34.46
7-1945    48.51   48.98   44.12   70.80  44.28
7-1946    50.00   48.51   48.98   44.12  70.80
7-1947    50.59   50.00   48.51   48.98  44.12
7-1948    42.53   50.59   50.00   48.51  48.98
7-1949    64.77   42.53   50.59   50.00  48.51
7-1950    72.68   64.77   42.53   50.59  50.00
7-1951    73.86   72.68   64.77   42.53  50.59
7-1952    89.51   73.86   72.68   64.77  42.53
7-1953       NA   89.51   73.86   72.68  64.77
7-1954       NA      NA   89.51   73.86  72.68
8-1935    35.05   25.90   12.93      NA     NA
8-1936    22.89   35.05   25.90   12.93     NA
8-1937    18.84   22.89   35.05   25.90  12.93
8-1938    28.57   18.84   22.89   35.05  25.90
8-1939    48.51   28.57   18.84   22.89  35.05
8-1940    43.34   48.51   28.57   18.84  22.89
8-1941    37.02   43.34   48.51   28.57  18.84
8-1942    37.81   37.02   43.34   48.51  28.57
8-1943    39.27   37.81   37.02   43.34  48.51
8-1944    53.46   39.27   37.81   37.02  43.34
8-1945    55.56   53.46   39.27   37.81  37.02
8-1946    49.56   55.56   53.46   39.27  37.81
8-1947    32.04   49.56   55.56   53.46  39.27
8-1948    32.24   32.04   49.56   55.56  53.46
8-1949    54.38   32.24   32.04   49.56  55.56
8-1950    71.78   54.38   32.24   32.04  49.56
8-1951    90.08   71.78   54.38   32.24  32.04
8-1952    68.60   90.08   71.78   54.38  32.24
8-1953       NA   68.60   90.08   71.78  54.38
8-1954       NA      NA   68.60   90.08  71.78
9-1935    30.65   23.39   26.63      NA     NA
9-1936    20.89   30.65   23.39   26.63     NA
9-1937    28.78   20.89   30.65   23.39  26.63
9-1938    26.93   28.78   20.89   30.65  23.39
9-1939    32.08   26.93   28.78   20.89  30.65
9-1940    32.21   32.08   26.93   28.78  20.89
9-1941    35.69   32.21   32.08   26.93  28.78
9-1942    62.47   35.69   32.21   32.08  26.93
9-1943    52.32   62.47   35.69   32.21  32.08
9-1944    56.95   52.32   62.47   35.69  32.21
9-1945    54.32   56.95   52.32   62.47  35.69
9-1946    40.53   54.32   56.95   52.32  62.47
9-1947    32.54   40.53   54.32   56.95  52.32
9-1948    43.48   32.54   40.53   54.32  56.95
9-1949    56.49   43.48   32.54   40.53  54.32
9-1950    65.98   56.49   43.48   32.54  40.53
9-1951    66.11   65.98   56.49   43.48  32.54
9-1952    49.34   66.11   65.98   56.49  43.48
9-1953       NA   49.34   66.11   65.98  56.49
9-1954       NA      NA   49.34   66.11  65.98
10-1935    2.19    2.00    2.54      NA     NA
10-1936    1.99    2.19    2.00    2.54     NA
10-1937    2.03    1.99    2.19    2.00   2.54
10-1938    1.81    2.03    1.99    2.19   2.00
10-1939    2.14    1.81    2.03    1.99   2.19
10-1940    1.86    2.14    1.81    2.03   1.99
10-1941    0.93    1.86    2.14    1.81   2.03
10-1942    1.18    0.93    1.86    2.14   1.81
10-1943    1.36    1.18    0.93    1.86   2.14
10-1944    2.24    1.36    1.18    0.93   1.86
10-1945    3.81    2.24    1.36    1.18   0.93
10-1946    5.66    3.81    2.24    1.36   1.18
10-1947    4.21    5.66    3.81    2.24   1.36
10-1948    3.42    4.21    5.66    3.81   2.24
10-1949    4.67    3.42    4.21    5.66   3.81
10-1950    6.00    4.67    3.42    4.21   5.66
10-1951    6.53    6.00    4.67    3.42   4.21
10-1952    5.12    6.53    6.00    4.67   3.42
10-1953      NA    5.12    6.53    6.00   4.67
10-1954      NA      NA    5.12    6.53   6.00
> lead(Grunfeld$inv, c(-2, -1, 0, 1, 2))
            -2      -1       0       1       2
1-1935      NA      NA  317.60  391.80  410.60
1-1936      NA  317.60  391.80  410.60  257.70
1-1937  317.60  391.80  410.60  257.70  330.80
1-1938  391.80  410.60  257.70  330.80  461.20
1-1939  410.60  257.70  330.80  461.20  512.00
1-1940  257.70  330.80  461.20  512.00  448.00
1-1941  330.80  461.20  512.00  448.00  499.60
1-1942  461.20  512.00  448.00  499.60  547.50
1-1943  512.00  448.00  499.60  547.50  561.20
1-1944  448.00  499.60  547.50  561.20  688.10
1-1945  499.60  547.50  561.20  688.10  568.90
1-1946  547.50  561.20  688.10  568.90  529.20
1-1947  561.20  688.10  568.90  529.20  555.10
1-1948  688.10  568.90  529.20  555.10  642.90
1-1949  568.90  529.20  555.10  642.90  755.90
1-1950  529.20  555.10  642.90  755.90  891.20
1-1951  555.10  642.90  755.90  891.20 1304.40
1-1952  642.90  755.90  891.20 1304.40 1486.70
1-1953  755.90  891.20 1304.40 1486.70      NA
1-1954  891.20 1304.40 1486.70      NA      NA
2-1935      NA      NA  209.90  355.30  469.90
2-1936      NA  209.90  355.30  469.90  262.30
2-1937  209.90  355.30  469.90  262.30  230.40
2-1938  355.30  469.90  262.30  230.40  361.60
2-1939  469.90  262.30  230.40  361.60  472.80
2-1940  262.30  230.40  361.60  472.80  445.60
2-1941  230.40  361.60  472.80  445.60  361.60
2-1942  361.60  472.80  445.60  361.60  288.20
2-1943  472.80  445.60  361.60  288.20  258.70
2-1944  445.60  361.60  288.20  258.70  420.30
2-1945  361.60  288.20  258.70  420.30  420.50
2-1946  288.20  258.70  420.30  420.50  494.50
2-1947  258.70  420.30  420.50  494.50  405.10
2-1948  420.30  420.50  494.50  405.10  418.80
2-1949  420.50  494.50  405.10  418.80  588.20
2-1950  494.50  405.10  418.80  588.20  645.50
2-1951  405.10  418.80  588.20  645.50  641.00
2-1952  418.80  588.20  645.50  641.00  459.30
2-1953  588.20  645.50  641.00  459.30      NA
2-1954  645.50  641.00  459.30      NA      NA
3-1935      NA      NA   33.10   45.00   77.20
3-1936      NA   33.10   45.00   77.20   44.60
3-1937   33.10   45.00   77.20   44.60   48.10
3-1938   45.00   77.20   44.60   48.10   74.40
3-1939   77.20   44.60   48.10   74.40  113.00
3-1940   44.60   48.10   74.40  113.00   91.90
3-1941   48.10   74.40  113.00   91.90   61.30
3-1942   74.40  113.00   91.90   61.30   56.80
3-1943  113.00   91.90   61.30   56.80   93.60
3-1944   91.90   61.30   56.80   93.60  159.90
3-1945   61.30   56.80   93.60  159.90  147.20
3-1946   56.80   93.60  159.90  147.20  146.30
3-1947   93.60  159.90  147.20  146.30   98.30
3-1948  159.90  147.20  146.30   98.30   93.50
3-1949  147.20  146.30   98.30   93.50  135.20
3-1950  146.30   98.30   93.50  135.20  157.30
3-1951   98.30   93.50  135.20  157.30  179.50
3-1952   93.50  135.20  157.30  179.50  189.60
3-1953  135.20  157.30  179.50  189.60      NA
3-1954  157.30  179.50  189.60      NA      NA
4-1935      NA      NA   40.29   72.76   66.26
4-1936      NA   40.29   72.76   66.26   51.60
4-1937   40.29   72.76   66.26   51.60   52.41
4-1938   72.76   66.26   51.60   52.41   69.41
4-1939   66.26   51.60   52.41   69.41   68.35
4-1940   51.60   52.41   69.41   68.35   46.80
4-1941   52.41   69.41   68.35   46.80   47.40
4-1942   69.41   68.35   46.80   47.40   59.57
4-1943   68.35   46.80   47.40   59.57   88.78
4-1944   46.80   47.40   59.57   88.78   74.12
4-1945   47.40   59.57   88.78   74.12   62.68
4-1946   59.57   88.78   74.12   62.68   89.36
4-1947   88.78   74.12   62.68   89.36   78.98
4-1948   74.12   62.68   89.36   78.98  100.66
4-1949   62.68   89.36   78.98  100.66  160.62
4-1950   89.36   78.98  100.66  160.62  145.00
4-1951   78.98  100.66  160.62  145.00  174.93
4-1952  100.66  160.62  145.00  174.93  172.49
4-1953  160.62  145.00  174.93  172.49      NA
4-1954  145.00  174.93  172.49      NA      NA
5-1935      NA      NA   39.68   50.73   74.24
5-1936      NA   39.68   50.73   74.24   53.51
5-1937   39.68   50.73   74.24   53.51   42.65
5-1938   50.73   74.24   53.51   42.65   46.48
5-1939   74.24   53.51   42.65   46.48   61.40
5-1940   53.51   42.65   46.48   61.40   39.67
5-1941   42.65   46.48   61.40   39.67   62.24
5-1942   46.48   61.40   39.67   62.24   52.32
5-1943   61.40   39.67   62.24   52.32   63.21
5-1944   39.67   62.24   52.32   63.21   59.37
5-1945   62.24   52.32   63.21   59.37   58.02
5-1946   52.32   63.21   59.37   58.02   70.34
5-1947   63.21   59.37   58.02   70.34   67.42
5-1948   59.37   58.02   70.34   67.42   55.74
5-1949   58.02   70.34   67.42   55.74   80.30
5-1950   70.34   67.42   55.74   80.30   85.40
5-1951   67.42   55.74   80.30   85.40   91.90
5-1952   55.74   80.30   85.40   91.90   81.43
5-1953   80.30   85.40   91.90   81.43      NA
5-1954   85.40   91.90   81.43      NA      NA
6-1935      NA      NA   20.36   25.98   25.94
6-1936      NA   20.36   25.98   25.94   27.53
6-1937   20.36   25.98   25.94   27.53   24.60
6-1938   25.98   25.94   27.53   24.60   28.54
6-1939   25.94   27.53   24.60   28.54   43.41
6-1940   27.53   24.60   28.54   43.41   42.81
6-1941   24.60   28.54   43.41   42.81   27.84
6-1942   28.54   43.41   42.81   27.84   32.60
6-1943   43.41   42.81   27.84   32.60   39.03
6-1944   42.81   27.84   32.60   39.03   50.17
6-1945   27.84   32.60   39.03   50.17   51.85
6-1946   32.60   39.03   50.17   51.85   64.03
6-1947   39.03   50.17   51.85   64.03   68.16
6-1948   50.17   51.85   64.03   68.16   77.34
6-1949   51.85   64.03   68.16   77.34   95.30
6-1950   64.03   68.16   77.34   95.30   99.49
6-1951   68.16   77.34   95.30   99.49  127.52
6-1952   77.34   95.30   99.49  127.52  135.72
6-1953   95.30   99.49  127.52  135.72      NA
6-1954   99.49  127.52  135.72      NA      NA
7-1935      NA      NA   24.43   23.21   32.78
7-1936      NA   24.43   23.21   32.78   32.54
7-1937   24.43   23.21   32.78   32.54   26.65
7-1938   23.21   32.78   32.54   26.65   33.71
7-1939   32.78   32.54   26.65   33.71   43.50
7-1940   32.54   26.65   33.71   43.50   34.46
7-1941   26.65   33.71   43.50   34.46   44.28
7-1942   33.71   43.50   34.46   44.28   70.80
7-1943   43.50   34.46   44.28   70.80   44.12
7-1944   34.46   44.28   70.80   44.12   48.98
7-1945   44.28   70.80   44.12   48.98   48.51
7-1946   70.80   44.12   48.98   48.51   50.00
7-1947   44.12   48.98   48.51   50.00   50.59
7-1948   48.98   48.51   50.00   50.59   42.53
7-1949   48.51   50.00   50.59   42.53   64.77
7-1950   50.00   50.59   42.53   64.77   72.68
7-1951   50.59   42.53   64.77   72.68   73.86
7-1952   42.53   64.77   72.68   73.86   89.51
7-1953   64.77   72.68   73.86   89.51      NA
7-1954   72.68   73.86   89.51      NA      NA
8-1935      NA      NA   12.93   25.90   35.05
8-1936      NA   12.93   25.90   35.05   22.89
8-1937   12.93   25.90   35.05   22.89   18.84
8-1938   25.90   35.05   22.89   18.84   28.57
8-1939   35.05   22.89   18.84   28.57   48.51
8-1940   22.89   18.84   28.57   48.51   43.34
8-1941   18.84   28.57   48.51   43.34   37.02
8-1942   28.57   48.51   43.34   37.02   37.81
8-1943   48.51   43.34   37.02   37.81   39.27
8-1944   43.34   37.02   37.81   39.27   53.46
8-1945   37.02   37.81   39.27   53.46   55.56
8-1946   37.81   39.27   53.46   55.56   49.56
8-1947   39.27   53.46   55.56   49.56   32.04
8-1948   53.46   55.56   49.56   32.04   32.24
8-1949   55.56   49.56   32.04   32.24   54.38
8-1950   49.56   32.04   32.24   54.38   71.78
8-1951   32.04   32.24   54.38   71.78   90.08
8-1952   32.24   54.38   71.78   90.08   68.60
8-1953   54.38   71.78   90.08   68.60      NA
8-1954   71.78   90.08   68.60      NA      NA
9-1935      NA      NA   26.63   23.39   30.65
9-1936      NA   26.63   23.39   30.65   20.89
9-1937   26.63   23.39   30.65   20.89   28.78
9-1938   23.39   30.65   20.89   28.78   26.93
9-1939   30.65   20.89   28.78   26.93   32.08
9-1940   20.89   28.78   26.93   32.08   32.21
9-1941   28.78   26.93   32.08   32.21   35.69
9-1942   26.93   32.08   32.21   35.69   62.47
9-1943   32.08   32.21   35.69   62.47   52.32
9-1944   32.21   35.69   62.47   52.32   56.95
9-1945   35.69   62.47   52.32   56.95   54.32
9-1946   62.47   52.32   56.95   54.32   40.53
9-1947   52.32   56.95   54.32   40.53   32.54
9-1948   56.95   54.32   40.53   32.54   43.48
9-1949   54.32   40.53   32.54   43.48   56.49
9-1950   40.53   32.54   43.48   56.49   65.98
9-1951   32.54   43.48   56.49   65.98   66.11
9-1952   43.48   56.49   65.98   66.11   49.34
9-1953   56.49   65.98   66.11   49.34      NA
9-1954   65.98   66.11   49.34      NA      NA
10-1935     NA      NA    2.54    2.00    2.19
10-1936     NA    2.54    2.00    2.19    1.99
10-1937   2.54    2.00    2.19    1.99    2.03
10-1938   2.00    2.19    1.99    2.03    1.81
10-1939   2.19    1.99    2.03    1.81    2.14
10-1940   1.99    2.03    1.81    2.14    1.86
10-1941   2.03    1.81    2.14    1.86    0.93
10-1942   1.81    2.14    1.86    0.93    1.18
10-1943   2.14    1.86    0.93    1.18    1.36
10-1944   1.86    0.93    1.18    1.36    2.24
10-1945   0.93    1.18    1.36    2.24    3.81
10-1946   1.18    1.36    2.24    3.81    5.66
10-1947   1.36    2.24    3.81    5.66    4.21
10-1948   2.24    3.81    5.66    4.21    3.42
10-1949   3.81    5.66    4.21    3.42    4.67
10-1950   5.66    4.21    3.42    4.67    6.00
10-1951   4.21    3.42    4.67    6.00    6.53
10-1952   3.42    4.67    6.00    6.53    5.12
10-1953   4.67    6.00    6.53    5.12      NA
10-1954   6.00    6.53    5.12      NA      NA
> if(!isTRUE(all.equal(lag(Grunfeld$inv, c(-2, -1, 0, 1, 2)),
+                      lead(Grunfeld$inv, -1*c(-2, -1, 0, 1, 2)), check.attributes = FALSE))) stop("'lag( , c())' not equal to 'lead( , -1*c())'")
> 
> # other data set (different time periods)
> # Hedonic is an unbalanced panel, townid is the individual index
> data("Hedonic", package = "plm")
> Hed <- pdata.frame(Hedonic, index = "townid")
> head(Hed$age, 20)
      1-1       2-1       2-2       3-1       3-2       3-3       4-1       4-2 
 65.19995  78.89996  61.09998  45.79999  54.19998  58.69998  66.59998  96.09998 
      4-3       4-4       4-5       4-6       4-7       5-1       5-2       5-3 
100.00000  85.89996  94.29999  82.89996  39.00000  61.79999  84.50000  56.50000 
      5-4       5-5       5-6       5-7 
 29.29999  81.69995  36.59998  69.50000 
> head(lag(Hed$age), 20)
      1-1       2-1       2-2       3-1       3-2       3-3       4-1       4-2 
       NA        NA  78.89996        NA  45.79999  54.19998        NA  66.59998 
      4-3       4-4       4-5       4-6       4-7       5-1       5-2       5-3 
 96.09998 100.00000  85.89996  94.29999  82.89996        NA  61.79999  84.50000 
      5-4       5-5       5-6       5-7 
 56.50000  29.29999  81.69995  36.59998 
> head(lag(Hed$age, c(0,1,2)), 20)
            0         1         2
1-1  65.19995        NA        NA
2-1  78.89996        NA        NA
2-2  61.09998  78.89996        NA
3-1  45.79999        NA        NA
3-2  54.19998  45.79999        NA
3-3  58.69998  54.19998  45.79999
4-1  66.59998        NA        NA
4-2  96.09998  66.59998        NA
4-3 100.00000  96.09998  66.59998
4-4  85.89996 100.00000  96.09998
4-5  94.29999  85.89996 100.00000
4-6  82.89996  94.29999  85.89996
4-7  39.00000  82.89996  94.29999
5-1  61.79999        NA        NA
5-2  84.50000  61.79999        NA
5-3  56.50000  84.50000  61.79999
5-4  29.29999  56.50000  84.50000
5-5  81.69995  29.29999  56.50000
5-6  36.59998  81.69995  29.29999
5-7  69.50000  36.59998  81.69995
> if (!isTRUE(all.equal(lag(Hed$age, c(0,1,2,3,4,5)), lead(Hed$age, -1*c(0,1,2,3,4,5)), check.attributes = FALSE))) stop("'lag( , 1)' not equal to 'lead( , -1)'")
> 
> 
> 
> # diff
> if (!isTRUE(all.equal(diff(Grunfeld$inv), Grunfeld$inv - lag(Grunfeld$inv)))) stop("'diff()' not corresponding to differences with 'lag()'")
> if (!isTRUE(all.equal(diff(Grunfeld$inv, 2), Grunfeld$inv - lag(Grunfeld$inv, 2)))) stop("'diff( , 2)' not corresponding to differences with 'lag( , 2)'")
> 
> 
> 
> ############## (4) test with non-consecutive time periods ####
> data("Grunfeld", package = "plm")
> 
> pGrunfeld_missing_period <- pdata.frame(Grunfeld[-2, ]) # delete one time period of first individual (1-1936 is missing (not NA))
> 
> is.pconsecutive(pGrunfeld_missing_period)
    1     2     3     4     5     6     7     8     9    10 
FALSE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE 
> 
> head(pGrunfeld_missing_period$inv, 25)
1-1935 1-1937 1-1938 1-1939 1-1940 1-1941 1-1942 1-1943 1-1944 1-1945 1-1946 
 317.6  410.6  257.7  330.8  461.2  512.0  448.0  499.6  547.5  561.2  688.1 
1-1947 1-1948 1-1949 1-1950 1-1951 1-1952 1-1953 1-1954 2-1935 2-1936 2-1937 
 568.9  529.2  555.1  642.9  755.9  891.2 1304.4 1486.7  209.9  355.3  469.9 
2-1938 2-1939 2-1940 
 262.3  230.4  361.6 
> head(test_Grun_miss_p_lag1 <- lag(pGrunfeld_missing_period$inv), 25) # correct: additional NA for the missing time period is introduced at 1-1937
1-1935 1-1937 1-1938 1-1939 1-1940 1-1941 1-1942 1-1943 1-1944 1-1945 1-1946 
    NA     NA  410.6  257.7  330.8  461.2  512.0  448.0  499.6  547.5  561.2 
1-1947 1-1948 1-1949 1-1950 1-1951 1-1952 1-1953 1-1954 2-1935 2-1936 2-1937 
 688.1  568.9  529.2  555.1  642.9  755.9  891.2 1304.4     NA  209.9  355.3 
2-1938 2-1939 2-1940 
 469.9  262.3  230.4 
> head(lag(pGrunfeld_missing_period$inv, 2), 25)
1-1935 1-1937 1-1938 1-1939 1-1940 1-1941 1-1942 1-1943 1-1944 1-1945 1-1946 
    NA  317.6     NA  410.6  257.7  330.8  461.2  512.0  448.0  499.6  547.5 
1-1947 1-1948 1-1949 1-1950 1-1951 1-1952 1-1953 1-1954 2-1935 2-1936 2-1937 
 561.2  688.1  568.9  529.2  555.1  642.9  755.9  891.2     NA     NA  209.9 
2-1938 2-1939 2-1940 
 355.3  469.9  262.3 
> head(test_Grun_miss_p_lag3 <- lag(pGrunfeld_missing_period$inv, 3), 25) # correct: 1-1938 should be non-NA (former 1-1935: 317.6)
1-1935 1-1937 1-1938 1-1939 1-1940 1-1941 1-1942 1-1943 1-1944 1-1945 1-1946 
    NA     NA  317.6     NA  410.6  257.7  330.8  461.2  512.0  448.0  499.6 
1-1947 1-1948 1-1949 1-1950 1-1951 1-1952 1-1953 1-1954 2-1935 2-1936 2-1937 
 547.5  561.2  688.1  568.9  529.2  555.1  642.9  755.9     NA     NA     NA 
2-1938 2-1939 2-1940 
 209.9  355.3  469.9 
> 
> ### formal test for correct value
> if (!is.na(test_Grun_miss_p_lag1["1-1937"])) stop("lag(pGrunfeld_missing_period$inv, 1)' for '1-1937' contains a value but should be 'NA'")
> 
> 
> if (!is.na(test_Grun_miss_p_lag3["1-1938"])) {
+   if(!isTRUE(all.equal(test_Grun_miss_p_lag3["1-1938"], pGrunfeld_missing_period$inv["1-1935"], check.names = FALSE)))
+     stop("'lag(pGrunfeld_missing_period$inv, 3)' for '1-1938' is not the expected value of '1-1935' of original data 'pGrunfeld_missing_period$inv'")
+   } else stop("'lag(pGrunfeld_missing_period$inv, 3)' is NA for '1-1938' but should be the value of '1-1935' from original data 'pGrunfeld_missing_period$inv'")
> 
> 
> length(pGrunfeld_missing_period$inv) == length(lag(pGrunfeld_missing_period$inv))
[1] TRUE
> 
> # with different data set
> data("Hedonic", package = "plm")
> Hed_missing_period <- pdata.frame(Hedonic, index = "townid")
> Hed_missing_period <- as.data.frame(Hed_missing_period)
> Hed_missing_period <- Hed_missing_period[-c(5,11), ]  # delete 3-2 and 4-5
> Hed_missing_period <- pdata.frame(Hed_missing_period, index = c("townid", "time"))
> 
> is.pconsecutive(Hed_missing_period)
    1     2     3     4     5     6     7     8     9    10    11    12    13 
 TRUE  TRUE FALSE FALSE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE 
   14    15    16    17    18    19    20    21    22    23    24    25    26 
 TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE 
   27    28    29    30    31    32    33    34    35    36    37    38    39 
 TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE 
   40    41    42    43    44    45    46    47    48    49    50    51    52 
 TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE 
   53    54    55    56    57    58    59    60    61    62    63    64    65 
 TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE 
   66    67    68    69    70    71    72    73    74    75    76    77    78 
 TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE 
   79    80    81    82    83    84    85    86    87    88    89    90    91 
 TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE 
   92 
 TRUE 
> 
> head(Hed_missing_period$age, 20)
      1-1       2-1       2-2       3-1       3-3       4-1       4-2       4-3 
 65.19995  78.89996  61.09998  45.79999  58.69998  66.59998  96.09998 100.00000 
      4-4       4-6       4-7       5-1       5-2       5-3       5-4       5-5 
 85.89996  82.89996  39.00000  61.79999  84.50000  56.50000  29.29999  81.69995 
      5-6       5-7       5-8       5-9 
 36.59998  69.50000  98.09998  89.19995 
> head(test_Hed_miss_p_lag1 <- lag(Hed_missing_period$age), 20)    # correct: lag(, 1): additional NAs introduced at (among others) 3-3 and 4-6
      1-1       2-1       2-2       3-1       3-3       4-1       4-2       4-3 
       NA        NA  78.89996        NA        NA        NA  66.59998  96.09998 
      4-4       4-6       4-7       5-1       5-2       5-3       5-4       5-5 
100.00000        NA  82.89996        NA  61.79999  84.50000  56.50000  29.29999 
      5-6       5-7       5-8       5-9 
 81.69995  36.59998  69.50000  98.09998 
> head(test_Hed_miss_p_lag2 <- lag(Hed_missing_period$age, 2), 20) # correct: lag(, 2): 4-6 should be former 4-4: 85.89996
     1-1      2-1      2-2      3-1      3-3      4-1      4-2      4-3 
      NA       NA       NA       NA 45.79999       NA       NA 66.59998 
     4-4      4-6      4-7      5-1      5-2      5-3      5-4      5-5 
96.09998 85.89996       NA       NA       NA 61.79999 84.50000 56.50000 
     5-6      5-7      5-8      5-9 
29.29999 81.69995 36.59998 69.50000 
>                                                                  #                    3-3 should be former 3-1: 45.79999
> 
> head(lag(Hed_missing_period$age, c(0,1,2)), 20) # view all at once
            0         1        2
1-1  65.19995        NA       NA
2-1  78.89996        NA       NA
2-2  61.09998  78.89996       NA
3-1  45.79999        NA       NA
3-3  58.69998        NA 45.79999
4-1  66.59998        NA       NA
4-2  96.09998  66.59998       NA
4-3 100.00000  96.09998 66.59998
4-4  85.89996 100.00000 96.09998
4-6  82.89996        NA 85.89996
4-7  39.00000  82.89996       NA
5-1  61.79999        NA       NA
5-2  84.50000  61.79999       NA
5-3  56.50000  84.50000 61.79999
5-4  29.29999  56.50000 84.50000
5-5  81.69995  29.29999 56.50000
5-6  36.59998  81.69995 29.29999
5-7  69.50000  36.59998 81.69995
5-8  98.09998  69.50000 36.59998
5-9  89.19995  98.09998 69.50000
> 
> ### formal tests for correct values
> # lag(, 1)
> if(!is.na(test_Hed_miss_p_lag1["3-3"])) stop("lag(Hed_missing_period$age, 1)' for '3-3' contains a value but should be 'NA'")
> if(!is.na(test_Hed_miss_p_lag1["4-6"])) stop("lag(Hed_missing_period$age, 1)' for '4-6' contains a value but should be 'NA'")
> 
> # lag(, 2)
> if (!is.na(test_Hed_miss_p_lag2["3-3"])) {
+   if(!isTRUE(all.equal(test_Hed_miss_p_lag2["3-3"], Hed_missing_period$age["3-1"], check.names = FALSE)))
+     stop("'lag(Hed_missing_period$age, 2)' for '3-3' is not the expected value of '3-1' of original data 'Hed_missing_period$age'")
+   } else stop("'lag(Hed_missing_period$age, 2)' is NA for '3-3' but should be the value of '3-1' from original data 'Hed_missing_period$age'")
> 
> if (!is.na(test_Hed_miss_p_lag2["4-6"])) {
+   if(!isTRUE(all.equal(test_Hed_miss_p_lag2["4-6"], Hed_missing_period$age["4-4"], check.names = FALSE)))
+     stop("'lag(Hed_missing_period$age, 2)' for '4-6' is not the expected value of '4-4' of original data 'Hed_missing_period$age'")
+   } else stop("'lag(Hed_missing_period$age, 2)' is NA for '4-6' but should be the value of '4-4' from original data 'Hed_missing_period$age'")
> 
> ##### delete two consecutive time periods
> data("Hedonic", package = "plm")
> Hed_missing_period2 <- pdata.frame(Hedonic, index = "townid")
> Hed_missing_period2 <- as.data.frame(Hed_missing_period2)
> Hed_missing_period2 <- Hed_missing_period2[-c(5,11,12), ]  # delete 3-2, 4-5, 4-6
> Hed_missing_period2 <- pdata.frame(Hed_missing_period2, index = c("townid", "time"))
> 
> is.pconsecutive(Hed_missing_period2)
    1     2     3     4     5     6     7     8     9    10    11    12    13 
 TRUE  TRUE FALSE FALSE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE 
   14    15    16    17    18    19    20    21    22    23    24    25    26 
 TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE 
   27    28    29    30    31    32    33    34    35    36    37    38    39 
 TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE 
   40    41    42    43    44    45    46    47    48    49    50    51    52 
 TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE 
   53    54    55    56    57    58    59    60    61    62    63    64    65 
 TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE 
   66    67    68    69    70    71    72    73    74    75    76    77    78 
 TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE 
   79    80    81    82    83    84    85    86    87    88    89    90    91 
 TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE 
   92 
 TRUE 
> 
> head(Hed_missing_period2$age, 20)
      1-1       2-1       2-2       3-1       3-3       4-1       4-2       4-3 
 65.19995  78.89996  61.09998  45.79999  58.69998  66.59998  96.09998 100.00000 
      4-4       4-7       5-1       5-2       5-3       5-4       5-5       5-6 
 85.89996  39.00000  61.79999  84.50000  56.50000  29.29999  81.69995  36.59998 
      5-7       5-8       5-9      5-10 
 69.50000  98.09998  89.19995  91.69995 
> head(test_Hed_miss2_p_lag1 <- lag(Hed_missing_period2$age), 20)    # correct: lag(, 1): additional NAs introduced at 3-3 and 4-6
      1-1       2-1       2-2       3-1       3-3       4-1       4-2       4-3 
       NA        NA  78.89996        NA        NA        NA  66.59998  96.09998 
      4-4       4-7       5-1       5-2       5-3       5-4       5-5       5-6 
100.00000        NA        NA  61.79999  84.50000  56.50000  29.29999  81.69995 
      5-7       5-8       5-9      5-10 
 36.59998  69.50000  98.09998  89.19995 
> head(test_Hed_miss2_p_lag2 <- lag(Hed_missing_period2$age, 2), 20) # correct: 3-3 should be former 3-1 (45.79999)
     1-1      2-1      2-2      3-1      3-3      4-1      4-2      4-3 
      NA       NA       NA       NA 45.79999       NA       NA 66.59998 
     4-4      4-7      5-1      5-2      5-3      5-4      5-5      5-6 
96.09998       NA       NA       NA 61.79999 84.50000 56.50000 29.29999 
     5-7      5-8      5-9     5-10 
81.69995 36.59998 69.50000 98.09998 
> head(test_Hed_miss2_p_lag3 <- lag(Hed_missing_period2$age, 3), 20) # correct: 4-7 should be former 4-4 (85.89996)
     1-1      2-1      2-2      3-1      3-3      4-1      4-2      4-3 
      NA       NA       NA       NA       NA       NA       NA       NA 
     4-4      4-7      5-1      5-2      5-3      5-4      5-5      5-6 
66.59998 85.89996       NA       NA       NA 61.79999 84.50000 56.50000 
     5-7      5-8      5-9     5-10 
29.29999 81.69995 36.59998 69.50000 
> head(lag(Hed_missing_period2$age, c(0,1,2,3)), 20) # view all at once
             0         1        2        3
1-1   65.19995        NA       NA       NA
2-1   78.89996        NA       NA       NA
2-2   61.09998  78.89996       NA       NA
3-1   45.79999        NA       NA       NA
3-3   58.69998        NA 45.79999       NA
4-1   66.59998        NA       NA       NA
4-2   96.09998  66.59998       NA       NA
4-3  100.00000  96.09998 66.59998       NA
4-4   85.89996 100.00000 96.09998 66.59998
4-7   39.00000        NA       NA 85.89996
5-1   61.79999        NA       NA       NA
5-2   84.50000  61.79999       NA       NA
5-3   56.50000  84.50000 61.79999       NA
5-4   29.29999  56.50000 84.50000 61.79999
5-5   81.69995  29.29999 56.50000 84.50000
5-6   36.59998  81.69995 29.29999 56.50000
5-7   69.50000  36.59998 81.69995 29.29999
5-8   98.09998  69.50000 36.59998 81.69995
5-9   89.19995  98.09998 69.50000 36.59998
5-10  91.69995  89.19995 98.09998 69.50000
> 
> ### formal tests for correct values
> 
> ## lag(, 2)
> if (!is.na(test_Hed_miss2_p_lag2["3-3"])) {
+  if(!isTRUE(all.equal(test_Hed_miss2_p_lag2["3-3"], Hed_missing_period2$age["3-1"], check.names = FALSE)))
+    stop("'lag(Hed_missing_period2$age, 2)' for '3-3' is not the expected value of '3-1' of original data 'Hed_missing_period2$age'")
+  } else stop("'lag(Hed_missing_period2$age, 2)' is NA for '3-3' but should be the value of '3-1' from original data 'Hed_missing_period2$age'")
> 
> # lag(, 3)
> if (!is.na(test_Hed_miss2_p_lag3["4-7"])) {
+  if(!isTRUE(all.equal(test_Hed_miss2_p_lag3["4-7"], Hed_missing_period2$age["4-4"], check.names = FALSE)))
+    stop("'lag(Hed_missing_period2$age, 3)' for '4-7' is not the expected value of '4-4' of original data 'Hed_missing_period2$age'")
+  } else stop("'lag(Hed_missing_period2$age, 3)' is NA for '4-7' but should be the value of '4-4' from original data 'Hed_missing_period2$age'")
> 
> 
> ############ (5) lagt and lagr should yield same results on data with consecutive time periods ####################
> data("Grunfeld", package = "plm")
> Grunfeld <- pdata.frame(Grunfeld)
> 
> if (!isTRUE(identical(plm:::lagt.pseries(Grunfeld$inv, k = c(-3,-2,-1,0,1,2,3)), plm:::lagr.pseries(Grunfeld$inv, k = c(-3,-2,-1,0,1,2,3)))))
+   stop("lag and lagt not same on consecutive data.frame (but must be!)")
> 
> 
> ########### (6) NA in time index ##############
> dfNA <- data.frame(id=c(1,1,2,11,11),
+                  time=c(1,2,9,NA,NA),
+                  a=c(1,2,3,3.1,3.2),
+                  b=c(1,2,3,3.1,3.2))
> 
> pdfNA <- pdata.frame(dfNA)
Warning message:
In pdata.frame(dfNA) :
  at least one NA in at least one index dimension in resulting pdata.frame
 to find out which, use, e.g., table(index(your_pdataframe), useNA = "ifany")

> 
> if (!isTRUE(all.equal(as.numeric(plm:::lagt.pseries(pdfNA$a)), c(NA, 1.0, NA, NA, NA), check.attributes = FALSE)))
+   stop("NA in time period not dealt with correctly")
> 
> 
> ############## messy data set with lots of NAs ############
> #### commented because it needs several extra packages and loads data from the internet
> # library(haven)
> # 
> # nlswork_r8 <- haven::read_dta("http://www.stata-press.com/data/r8/nlswork.dta")
> # nlswork_r8 <- as.data.frame(lapply(nlswork_r8, function(x) {attr(x, "label") <- NULL; x}))
> # pnlswork_r8 <- pdata.frame(nlswork_r8, index=c("idcode", "year"), drop.index=F)
> #
> #
> # ### on a consecutive pdata.frame, plm:::lagr and plm:::lagt should yield same results (if no NA in id or time)
> # pnlswork_r8_consec <- make.pconsecutive(pnlswork_r8)
> # pnlswork_r8_consec_bal <- make.pconsecutive(pnlswork_r8, balanced = TRUE)
> # pnlswork_r8_bal <- make.pbalanced(pnlswork_r8, balanced = TRUE)
> #
> # if (!all.equal(plm:::lagr.pseries(pnlswork_r8_consec$age), plm:::lagt.pseries(pnlswork_r8_consec$age)))
> #  stop("lagr and lagt not same on consecutive data.frame (but must be!)")
> #
> # if (!all.equal(plm:::lagr.pseries(pnlswork_r8_consec_bal$age), plm:::lagt.pseries(pnlswork_r8_consec_bal$age)))
> #  stop("lagr and lagt not same on consecutive data.frame (but must be!)")
> # 
> ## ########### compare results to statar::tlag ########################
> # #### commented because it needs several extra packages
> # ## statar::tlag (and tlead) also works on the numbers of the time variable
> # ##
> # ### install.packages("statar")
> # #### devtools::install_github("matthieugomez/statar")
> # ## library(dplyr)
> # ##
> # ## lag 1
> #  nlswork_r8_statar <- dplyr::mutate(dplyr::group_by(nlswork_r8, idcode), agel = statar::tlag(age, n = 1, time = year))
> #  if (!isTRUE(all.equal(nlswork_r8_statar$agel, as.numeric(plm:::lagt.pseries(pnlswork_r8$age))))) stop("not same")
> # ## lag 2
> #  nlswork_r8_statar <- dplyr::mutate(dplyr::group_by(nlswork_r8, idcode), agel2 = statar::tlag(age, n = 2, time = year))
> #  if (!isTRUE(all.equal(nlswork_r8_statar$agel2, as.numeric(plm:::lagt.pseries(pnlswork_r8$age, 2))))) stop("not same")
> # ## lag 3
> #  nlswork_r8_statar <- dplyr::mutate(dplyr::group_by(nlswork_r8, idcode), agel2 = statar::tlag(age, n = 3, time = year))
> #  if (!isTRUE(all.equal(nlswork_r8_statar$agel2, as.numeric(plm:::lagt.pseries(pnlswork_r8$age, 3))))) stop("not same")
> #
> # ## lead 1
> #  nlswork_r8_statar <- dplyr::mutate(dplyr::group_by(nlswork_r8, idcode), agelead = statar::tlead(age, n = 1, time = year))
> #  if (!isTRUE(all.equal(nlswork_r8_statar$agelead, as.numeric(plm:::leadt.pseries(pnlswork_r8$age))))) stop("not same")
> # ## lead 2
> #  nlswork_r8_statar <- dplyr::mutate(dplyr::group_by(nlswork_r8, idcode), agelead2 = statar::tlead(age, n = 2, time = year))
> #  if (!isTRUE(all.equal(nlswork_r8_statar$agelead2, as.numeric(plm:::leadt.pseries(pnlswork_r8$age, 2))))) stop("not same")
> # ## lead 3
> #  nlswork_r8_statar <- dplyr::mutate(dplyr::group_by(nlswork_r8, idcode), agelead3 = statar::tlead(age, n = 3, time = year))
> #  if (!isTRUE(all.equal(nlswork_r8_statar$agelead3, as.numeric(plm:::leadt.pseries(pnlswork_r8$age, 3))))) stop("not same")
> 
> 
> 
> proc.time()
   user  system elapsed 
   2.00    0.12    2.07 
